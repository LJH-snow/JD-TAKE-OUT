# ğŸ“Š JDå¤–å–ç»Ÿè®¡ä¸æ ¸å¿ƒä¸šåŠ¡ç³»ç»Ÿè®¾è®¡ v2.1

**æ–‡æ¡£ç›®æ ‡**: è¯¦ç»†é˜è¿°JDå¤–å–é¡¹ç›®çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€æ•°æ®å¤„ç†ç­–ç•¥åŠç»Ÿè®¡åŠŸèƒ½çš„è®¾è®¡ä¸å®ç°ï¼Œä½œä¸ºå¼€å‘å’Œç»´æŠ¤çš„æ ¸å¿ƒå‚è€ƒã€‚

**æœ€åæ›´æ–°**: 2025å¹´9æœˆ11æ—¥

## 1. æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼šæ•°æ®å®Œæ•´æ€§ä¼˜å…ˆ

æœ¬ç³»ç»Ÿçš„æ‰€æœ‰è®¾è®¡éƒ½éµå¾ªä¸€ä¸ªæ ¸å¿ƒåŸåˆ™ï¼š**ä¿è¯æ ¸å¿ƒä¸šåŠ¡æ•°æ®çš„å®Œæ•´æ€§å’Œå†å²å¯è¿½æº¯æ€§**ã€‚è¿™æ„å‘³ç€ï¼Œä»»ä½•ä¸å†å²è®¢å•ç›¸å…³è”çš„æ•°æ®éƒ½ä¸èƒ½è¢«ç‰©ç†åˆ é™¤ï¼Œä»¥ç¡®ä¿ç»Ÿè®¡åˆ†æå’Œä¸šåŠ¡å®¡è®¡çš„å‡†ç¡®æ€§ã€‚åŸºäºæ­¤åŸåˆ™ï¼Œæˆ‘ä»¬é’ˆå¯¹ä¸åŒæ•°æ®å®ä½“è®¾è®¡äº†ç²¾ç»†åŒ–çš„å½’æ¡£ç­–ç•¥ã€‚

---

## 2. æ•°æ®å½’æ¡£ä¸åˆ é™¤ç­–ç•¥

é’ˆå¯¹ç³»ç»Ÿä¸­ä¸åŒçš„æ•°æ®å®ä½“ï¼Œæˆ‘ä»¬æ ¹æ®å…¶ä¸šåŠ¡å±æ€§ï¼Œè®¾è®¡äº†ä¸¤ç§ä¸åŒçš„å¤„ç†æ–¹å¼ï¼šâ€œ**è½¯åˆ é™¤** (Soft Delete)â€å’Œâ€œ**çŠ¶æ€æ ‡è®°** (Status Flag)â€ã€‚

| æ¨¡å— (Module) | ç›®æ ‡å®ä½“ (Entity) | ä¸šåŠ¡å«ä¹‰ (Business Meaning) | æŠ€æœ¯å®ç° (Technical Implementation) |
| :--- | :--- | :--- | :--- |
| **å•†å“ç®¡ç†** | `Dishes`, `Setmeals`, `Categories` | ä¸‹æ¶/åœå”® (Discontinue) | **è½¯åˆ é™¤**ï¼šä½¿ç”¨GORMå†…ç½®çš„ `gorm.DeletedAt` å­—æ®µã€‚ |
| **äººå‘˜ç®¡ç†** | `Employees` | ç¦»èŒ/ç¦ç”¨ (Resign/Disable) | **è½¯åˆ é™¤**ï¼šä½¿ç”¨ `gorm.DeletedAt` å­—æ®µã€‚ |
| **ç”¨æˆ·ç®¡ç†** | `Users` | ç¦ç”¨/å°å· (Deactivate/Ban) | **çŠ¶æ€æ ‡è®°**ï¼šä½¿ç”¨ `is_active` (boolean) å­—æ®µã€‚ |
| **è®¢å•ç®¡ç†** | `Orders` | å–æ¶ˆ/é€€æ¬¾ (Cancel/Refund) | **çŠ¶æ€æ ‡è®°**ï¼šä½¿ç”¨ `status` (integer) å­—æ®µï¼Œä¾‹å¦‚ `6` ä»£è¡¨å·²å–æ¶ˆã€‚ |

### 2.1 è½¯åˆ é™¤ (Soft Delete)

- **é€‚ç”¨å¯¹è±¡**: `èœå“ (Dishes)`ã€`å¥—é¤ (Setmeals)`ã€`åˆ†ç±» (Categories)`ã€`å‘˜å·¥ (Employees)`ã€‚
- **å®ç°æ–¹å¼**:
    1. åœ¨GORMæ¨¡å‹ä¸­åµŒå…¥ `gorm.DeletedAt` å­—æ®µã€‚
    2. å½“æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ï¼ŒGORMä¼šè‡ªåŠ¨å°†SQL `DELETE` è½¬æ¢ä¸º `UPDATE table SET deleted_at = '...' WHERE id = ?`ã€‚
    3. æ‰€æœ‰å¸¸è§„æŸ¥è¯¢ï¼ˆå¦‚ `db.Find(&dishes)`)ï¼ŒGORMä¼šè‡ªåŠ¨é™„åŠ  `WHERE deleted_at IS NULL` æ¡ä»¶ï¼Œå¯¹ä¸šåŠ¡ä»£ç é€æ˜ã€‚
- **ä¼˜åŠ¿**: ä¸šåŠ¡ä»£ç æ— éœ€å…³å¿ƒâ€œå·²åˆ é™¤â€çŠ¶æ€ï¼Œæ¡†æ¶å±‚é¢ä¿è¯äº†æ•°æ®çš„éš”ç¦»æ€§ï¼ŒåŒæ—¶ä¿ç•™äº†æ‰€æœ‰å†å²æ•°æ®ä»¥ä¾›åˆ†æã€‚

### 2.2 çŠ¶æ€æ ‡è®° (Status Flag)

- **é€‚ç”¨å¯¹è±¡**: `ç”¨æˆ· (Users)`ã€`è®¢å• (Orders)`ã€‚
- **å®ç°æ–¹å¼**:
    1. åœ¨æ¨¡å‹ä¸­å®šä¹‰æ˜ç¡®çš„çŠ¶æ€å­—æ®µï¼Œå¦‚ `users.is_active` æˆ– `orders.status`ã€‚
    2. ä¸šåŠ¡é€»è¾‘é€šè¿‡ `UPDATE` è¯­å¥ä¿®æ”¹è¿™äº›å­—æ®µçš„å€¼æ¥æ”¹å˜å®ä½“çŠ¶æ€ã€‚
    3. æ‰€æœ‰æŸ¥è¯¢éƒ½éœ€è¦åœ¨ä¸šåŠ¡ä»£ç ä¸­æ˜¾å¼åœ°åŠ å…¥ `WHERE` æ¡ä»¶æ¥ç­›é€‰æ‰€éœ€çŠ¶æ€çš„å®ä½“ï¼Œä¾‹å¦‚ `db.Where("status = ?", 5).Find(&orders)`ã€‚
- **ä¼˜åŠ¿**: æä¾›äº†æ›´ä¸°å¯Œçš„ä¸šåŠ¡çŠ¶æ€ç®¡ç†èƒ½åŠ›ï¼Œä¾‹å¦‚è®¢å•çš„â€œå¾…ä»˜æ¬¾â€ã€â€œå¾…æ¥å•â€ã€â€œæ´¾é€ä¸­â€ç­‰å¤šç§çŠ¶æ€æµè½¬ã€‚

---

## 3. ç»Ÿè®¡ç³»ç»Ÿæ¶æ„

ä¸ºäº†æ”¯æ’‘å‰ç«¯é«˜æ•ˆã€å®æ—¶çš„æ•°æ®å¯è§†åŒ–éœ€æ±‚ï¼Œç»Ÿè®¡ç³»ç»Ÿé‡‡ç”¨äº†**æœåŠ¡å±‚ -> æ•°æ®åº“è§†å›¾**çš„åˆ†å±‚æ¶æ„ï¼Œä»¥å®ç°é«˜æ€§èƒ½çš„èšåˆæŸ¥è¯¢ã€‚

### 3.1 æ•°æ®æµåŠ¨ç¤ºæ„å›¾

```mermaid
graph TD
    A[ğŸ“ˆ ECharts @ Frontend] -->|HTTP Request| B(ğŸ“Š Stats API @ Gin Router);
    B -->|Call Function| C(âš™ï¸ Stats Service @ Go);
    C -->|Query| D(ğŸ“„ Database Views @ PostgreSQL);
    D -->|Aggregate| E(ğŸ—ƒï¸ Base Tables @ PostgreSQL);
```

### 3.2 æ¶æ„è§£æ

1.  **å‰ç«¯ (Frontend)**: Reactç»„ä»¶ (å¦‚ `SalesChart.jsx`) ä½¿ç”¨ ECharts åº“è´Ÿè´£å›¾è¡¨æ¸²æŸ“ï¼Œå¹¶é€šè¿‡ `api.js` å‘èµ·APIè¯·æ±‚ã€‚
2.  **APIå±‚ (API Layer)**: Gin Router (`router.go`) å®šä¹‰äº†é¢å‘å‰ç«¯çš„RESTfulæ¥å£ï¼Œè´Ÿè´£æ¥æ”¶è¯·æ±‚ã€å‚æ•°æ ¡éªŒï¼Œå¹¶è°ƒç”¨æœåŠ¡å±‚ã€‚
3.  **æœåŠ¡å±‚ (Service Layer)**: Goçš„ `StatsService` (`stats_service.go`) å°è£…äº†æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚å®ƒä¸ç›´æ¥æŸ¥è¯¢åŸå§‹æ•°æ®è¡¨ï¼Œè€Œæ˜¯æŸ¥è¯¢ç»è¿‡ä¼˜åŒ–çš„æ•°æ®åº“è§†å›¾ã€‚
4.  **è§†å›¾å±‚ (View Layer)**: åœ¨PostgreSQLä¸­é¢„å…ˆå®šä¹‰äº†ä¸€ç³»åˆ—è§†å›¾ (Views)ï¼Œè¿™äº›è§†å›¾ä½¿ç”¨ `JOIN` å’Œ `GROUP BY` å°†å¤æ‚çš„èšåˆè¿ç®—ï¼ˆå¦‚æŒ‰æ—¥ç»Ÿè®¡é”€å”®é¢ï¼‰æå‰å®Œæˆã€‚
5.  **æ•°æ®å±‚ (Data Layer)**: åŸå§‹çš„åŸºç¡€ä¸šåŠ¡æ•°æ®è¡¨ï¼Œå¦‚ `orders`, `order_details` ç­‰ã€‚

---

## 4. åç«¯å®ç°è¯¦è§£

### 4.1 æ•°æ®åº“è§†å›¾ (Database Views)

è§†å›¾æ˜¯ç»Ÿè®¡æ€§èƒ½çš„åŸºçŸ³ã€‚ä»¥ä¸‹æ˜¯é¡¹ç›®ä¸­å®šä¹‰çš„å››ä¸ªæ ¸å¿ƒç»Ÿè®¡è§†å›¾ï¼ˆæºäº `postgresql_single_merchant.sql`ï¼‰ï¼š

<details>
<summary><strong>1. æ¯æ—¥é”€å”®ç»Ÿè®¡è§†å›¾ (daily_sales_stats)</strong></summary>

```sql
CREATE VIEW daily_sales_stats AS
SELECT
    DATE(created_at) as sale_date,
    COUNT(*) as order_count,
    SUM(amount) as total_amount,
    AVG(amount) as avg_amount
FROM orders
WHERE status = 5  -- åªç»Ÿè®¡å·²å®Œæˆè®¢å•
GROUP BY DATE(created_at)
ORDER BY sale_date DESC;
```
</details>

<details>
<summary><strong>2. èœå“é”€é‡ç»Ÿè®¡è§†å›¾ (dish_sales_stats)</strong></summary>

```sql
CREATE VIEW dish_sales_stats AS
SELECT
    d.id,
    d.name,
    d.price,
    c.name as category_name,
    SUM(od.number) as total_sales,
    SUM(od.amount) as total_revenue
FROM dishes d
JOIN order_details od ON d.id = od.dish_id
JOIN orders o ON od.order_id = o.id
JOIN categories c ON d.category_id = c.id
WHERE o.status = 5
GROUP BY d.id, d.name, d.price, c.name
ORDER BY total_sales DESC;
```
</details>

<details>
<summary><strong>3. ç”¨æˆ·æ¶ˆè´¹ç»Ÿè®¡è§†å›¾ (user_consumption_stats)</strong></summary>

```sql
CREATE VIEW user_consumption_stats AS
SELECT
    u.id,
    u.name,
    u.phone,
    COUNT(o.id) as order_count,
    SUM(o.amount) as total_consumption,
    AVG(o.amount) as avg_order_amount,
    MAX(o.created_at) as last_order_time
FROM users u
JOIN orders o ON u.id = o.user_id
WHERE o.status = 5
GROUP BY u.id, u.name, u.phone
ORDER BY total_consumption DESC;
```
</details>

<details>
<summary><strong>4. åˆ†ç±»é”€å”®ç»Ÿè®¡è§†å›¾ (category_sales_stats)</strong></summary>

```sql
CREATE VIEW category_sales_stats AS
SELECT
    c.id,
    c.name as category_name,
    COUNT(od.id) as dish_count,
    SUM(od.number) as total_quantity,
    SUM(od.amount) as total_revenue
FROM categories c
JOIN dishes d ON c.id = d.category_id
JOIN order_details od ON d.id = od.dish_id
JOIN orders o ON od.order_id = o.id
WHERE o.status = 5
GROUP BY c.id, c.name
ORDER BY total_revenue DESC;
```
</details>

### 4.2 æ ¸å¿ƒç»Ÿè®¡APIæ¥å£

ä»¥ä¸‹æ˜¯ `router.go` ä¸­å®šä¹‰çš„ã€ä¾›å‰ç«¯è°ƒç”¨çš„æ ¸å¿ƒç»Ÿè®¡APIï¼Œå‡éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚

| Method | Endpoint | æ§åˆ¶å™¨æ–¹æ³• (Controller Method) | åŠŸèƒ½æè¿° |
| :--- | :--- | :--- | :--- |
| `GET` | `/api/v1/admin/dashboard/overview` | `statsController.GetDashboardOverview` | è·å–å·¥ä½œå°æ ¸å¿ƒæŒ‡æ ‡ |
| `GET` | `/api/v1/admin/stats/sales` | `statsController.GetSalesTrend` | è·å–æŒ‡å®šæ—¶é—´æ®µçš„é”€å”®è¶‹åŠ¿ |
| `GET` | `/api/v1/admin/stats/dishes` | `statsController.GetDishRanking` | è·å–çƒ­é”€èœå“æ’è¡Œ |
| `GET` | `/api/v1/admin/stats/categories` | `statsController.GetCategoryStats` | è·å–å„åˆ†ç±»çš„é”€å”®ç»Ÿè®¡ |

**é€šç”¨æŸ¥è¯¢å‚æ•°**:
- `start_date` (string): ç­›é€‰èŒƒå›´çš„å¼€å§‹æ—¥æœŸ (æ ¼å¼: `YYYY-MM-DD`)
- `end_date` (string): ç­›é€‰èŒƒå›´çš„ç»“æŸæ—¥æœŸ (æ ¼å¼: `YYYY-MM-DD`)

---

## 5. å·¥ä½œå°ä¸æ•°æ®å¯¼å‡º

### 5.1 å·¥ä½œå°æ ¸å¿ƒæŒ‡æ ‡

å·¥ä½œå° (`/dashboard/overview`) æ˜¯ç®¡ç†å‘˜ç™»å½•åçœ‹åˆ°çš„ç¬¬ä¸€ä¸ªé¡µé¢ï¼Œæä¾›æœ€æ ¸å¿ƒçš„5ä¸ªå®æ—¶ä¸šåŠ¡æŒ‡æ ‡ï¼š
1.  **è¥ä¸šé¢**: æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ€»é”€å”®é¢ (æ¥æº: `daily_sales_stats`)ã€‚
2.  **æœ‰æ•ˆè®¢å•**: æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„å·²å®Œæˆè®¢å•æ€»æ•° (æ¥æº: `daily_sales_stats`)ã€‚
3.  **è®¢å•å®Œæˆç‡**: `(å·²å®Œæˆè®¢å•æ•° / (å·²å®Œæˆè®¢å•æ•° + å·²å–æ¶ˆè®¢å•æ•°)) * 100%`ã€‚
4.  **å¹³å‡å®¢å•ä»·**: `æ€»è¥ä¸šé¢ / æœ‰æ•ˆè®¢å•æ•°`ã€‚
5.  **æ–°å¢ç”¨æˆ·æ•°**: æŒ‡å®šæ—¶é—´èŒƒå›´å†…æ–°æ³¨å†Œçš„ç”¨æˆ·æ•° (æ¥æº: `users` è¡¨)ã€‚

### 5.2 æ•°æ®å¯¼å‡ºåŠŸèƒ½

- **å®ç°æ–¹å¼**: åç«¯æä¾›ç»Ÿä¸€çš„ `/api/v1/admin/export/data` æ¥å£ã€‚
- **æ§åˆ¶å™¨æ–¹æ³•**: `statsController.ExportData`ã€‚
- **æ”¯æŒæ ¼å¼**: `Excel (XLSX)`ã€‚
- **è¯·æ±‚ä½“ç¤ºä¾‹**:
    ```json
    {
      "data_type": "sales", // å¯é€‰å€¼: "sales", "dishes", "categories"
      "start_date": "2025-01-01",
      "end_date": "2025-01-31"
    }
    ```
- **å“åº”**: åç«¯æ ¹æ® `data_type` æŸ¥è¯¢å¯¹åº”è§†å›¾ï¼Œç”ŸæˆExcelæ–‡ä»¶ï¼Œå¹¶é€šè¿‡æ–‡ä»¶æµå½¢å¼ç›´æ¥è¿”å›ç»™å‰ç«¯è§¦å‘ä¸‹è½½ã€‚

---